---
title: | 
  | \LARGE ASM Homework 2
subtitle: "Generalized Linear Model for JYB data"
author: "Maria Gkotsopoulou & Ricard Monge Calvo & Amalia Vradi"
date: "22/10/2019"
geometry: margin=1.5cm
output: 
  pdf_document: 
    latex_engine: xelatex
fontsize: 11pt
spacing: single
subparagraph: yes
header-includes: |
  \usepackage{titlesec}
  \usepackage{subfig}
  \titlespacing{\section}{0pt}{10pt plus 1pt minus 1pt}{0pt plus 1pt minus 1pt}
  \titlespacing{\subsection}{0pt}{10pt plus 1pt minus 1pt}{0pt plus 1pt minus 1pt}
  \titlespacing{\subsubsection}{0pt}{10pt plus 1pt minus 1pt}{0pt plus 1pt minus 1pt}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE,results="hide"}

############################################################
###############  libraries  & Functions      ############### 
############################################################

### load packages ###
requireorinstall=function(package=""){
  reqpac=parse(text=paste("require(",as.character(package),")"))
  if(eval(reqpac)){
    print(paste(as.character(package), "has been loaded correctly"))
  } else {
    print(paste("trying to install" ,as.character(package)))
    eval(parse(text=paste("try(install.packages(",as.character(package),"))")))
    if(eval(reqpac)){
      print(paste(as.character(package) ,"has been installed and loaded correctly"))
    } else {
      warning(paste("could not install",as.character(package)))
    }
  }
}


requireorinstall(c("knitr","kableExtra","ggplot2","ggsci","dplyr","tidyr",
                   "lmtest","tidyverse","broom","purrr","magrittr","grid",
                   "gridExtra","scales","GGally","fBasics", "car", "effects",
                   "emmeans", "viridis", "ggmosaic","woeBinning"))

## theme definition for ggplot 
ggstyle = theme(panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                panel.background = element_blank(),
                axis.line = element_blank(),
                axis.title.x = element_text(size = 10,
                                            vjust=0.1),
                axis.title.y = element_text(size = 10,
                                            vjust=1.5),
                axis.text.y = element_text(size=9),
                axis.text.x = element_text(size=9,
                                           angle = 45,
                                           vjust = 1,
                                           hjust=1),
                plot.title = element_text(size=11),
                legend.text = element_text( size=8),
                legend.title = element_text( size=9))

ggstyleFonts = theme(axis.title.x = element_text(size = 10,
                                                 vjust=0.1),
                     axis.title.y = element_text(size = 10,
                                                 vjust=1.5),
                     axis.text.y = element_text(size=9),
                     axis.text.x = element_text(size=9,
                                                angle = 45,
                                                vjust = 1,
                                                hjust=1),
                     plot.title = element_text(size=11),
                     legend.text = element_text( size=8),
                     legend.title = element_text( size=9))

```

# Exploratory Data Analysis

We check for any missing values or attributes without a value and find none nor NAs.

```{r,warning=FALSE,echo = FALSE,results="asis"}
jyb <- read.csv("JYB.csv", sep=";")

dfNum <- jyb %>% dplyr::select_if(is.numeric) %>% dplyr::select(-id)

t1<-data.frame(variable = names(dfNum),
           class = sapply(dfNum, class),
           min = sapply(dfNum, function(x) min(x)),
           mean = sapply(dfNum, function(x) mean(x)),
           median =  sapply(dfNum, function(x) median(x)),
           max = sapply(dfNum, function(x) max(x)),
           row.names = NULL)   %>%
  kable(format = "latex", booktabs = TRUE,digits = 2) %>% 
  kable_styling(position = "center",font_size = 9,
                latex_options = c("HOLD_position"))

t2<-jyb %>% 
  dplyr::select_if(is.factor) %>% 
  map(levels) %>% 
  map(length) %>% 
  unlist(recursive = FALSE) %>% 
  enframe() %>% 
  kable(format = "latex", booktabs = TRUE,
       col.names =c("attribute", "# levels"))%>%
  kable_styling(position = "center",font_size = 9,
                latex_options = c("HOLD_position"))

cat(c("\\begin{table}[!htb]
    \\begin{minipage}{.5\\linewidth}
      \\caption{Numerical variables}
      \\centering",
        t1,
    "\\end{minipage}%
    \\begin{minipage}{.5\\linewidth}
      \\centering
        \\caption{Categorical variables}",
        t2,
    "\\end{minipage} 
\\end{table}"
))
```


```{r,warning=FALSE,echo = FALSE,results="asis"}
plyr::ldply(jyb %>% dplyr::select_if(is.factor) %>%
              map(levels) , rbind) %>%
  mutate_all(funs(fct_explicit_na(., na_level = ""))) %>%
  kable(col.names= c("attribute",paste0(rep("level_",4),1:12)),
        format = "latex", booktabs = TRUE)%>%
  kable_styling(latex_options = "scale_down")
```

We are interested in predicting whether the customer subscribed to the deposit,
so our target variable *y* is a binary one. 

We now look closer into the relation between *y* and all the numerical 
variables.

```{r, echo = FALSE,fig.align="center",out.width = "400pt"}
jyb %>% 
  dplyr::select(c("y",colnames(jyb %>% 
                                 dplyr::select_if(is.numeric) %>% 
                                 dplyr::select(-id)))) %>%
  gather(-y, key = "some_var_name", value = "some_value_name") %>%
  ggplot(aes(x = some_value_name, fill = y)) +
  geom_density( alpha = .2) +
  scale_fill_viridis(name="y",option="plasma",  discrete = TRUE) +
  facet_wrap(~ some_var_name, scales = "free")+
  ggstyleFonts +
  theme(panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff'),
        legend.position="bottom")

```

```{r, echo = FALSE,fig.align="center",out.width = "400pt"}
jyb %>% 
  dplyr::select(c("y",colnames(jyb %>% 
                                 dplyr::select_if(is.numeric) %>% 
                                 dplyr::select(-id)))) %>%
  gather(-y, key = "some_var_name", value = "some_value_name") %>%
  ggplot(aes(x = y, y = some_value_name ,fill = y)) +
  geom_boxplot(outlier.size=0.05) +
  scale_fill_viridis(name="y",option="plasma",  discrete = TRUE) +
  facet_wrap(~ some_var_name, scales = "free")+
  ggstyleFonts +
  theme(panel.grid.major = element_blank(),
        axis.title.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff'),
        legend.position="bottom")

```

Furthermore, we look into the relation between *y* and all the factor 
variables.

```{r, echo = FALSE,fig.align="center",out.width = "500pt"}
mosaicYplusX <- function(factVar){
  ggplot(data = jyb) +
    geom_mosaic(aes_string(x = paste0("product(y,", factVar, ")"),
                           fill="y"), na.rm=TRUE) + 
    scale_fill_viridis(name="y",option="plasma",  discrete = TRUE)+
    ggstyleFonts +
    labs(x = factVar) +
    theme(panel.grid.major = element_blank(),
          panel.background = element_rect(fill = '#ffffff'),
          axis.text.y = element_text(size=7),
          axis.text.x = element_text(size=5),
          axis.title.y=element_blank(),
          legend.position="none")
}

factorNames <- colnames(jyb %>% dplyr::select_if(is.factor) %>% dplyr::select(-y))

p = list()
for(i in 1:(length(factorNames))) {
  p[[i]] = mosaicYplusX(factVar =factorNames[i])
}

do.call(grid.arrange, p )

rm(p)
```


```{r, echo = F,message=FALSE, warning=FALSE,results='asis'}
catdesOutput <- FactoMineR::catdes(jyb,21)

catdesOutput$test.chi2%>% 
  kable(format = "latex", booktabs = TRUE,digits = 32,
       caption = "description by categorical variables" ) %>% 
  kable_styling(position = "center",
                font_size = 9,
                latex_options = c("HOLD_position"))

catdesOutput$quanti.var%>% 
  kable(format = "latex", booktabs = TRUE,digits = 32,
       caption = "description by continuous variables" ) %>% 
  kable_styling(position = "center",
                font_size = 9,
                latex_options = c("HOLD_position"))


```

```{r}  
# check correlations for the numeric
jyb %>%
  select_if(is.numeric) %>%
  dplyr::select(-id) %>%
  cor() %>%
  corrplot::corrplot(method = "number", type = "upper", tl.cex = 0.8,
                     tl.offset = 0.5, tl.srt = 45)
```

# Complete Model

```{r, out.width="300pt"}
m.null <- glm(y~1, family = binomial(link = "logit"),
              data = jyb %>% select(-id))
m.full <- glm(y~., family = binomial(link = "logit"),
              data = jyb %>% select(-id))
# Compare full and null model by anova test
anova(m.null, m.full, test = "Chisq")
# View model summary
summary(m.full)
# See significance of factor variables
car::Anova(m.full)
# Plot model
plot(m.full)
```

# Evaluation First Order Interactions

```{r}
factors <- jyb %>% dplyr::select_if(is.factor) %>% colnames()
formula.inter <- as.formula(
  paste0("y~.*(", paste0(factors[1], collapse = "+"),")"))
m.inter <- glm(formula.inter, family = binomial(link = "logit"), data = jyb)
summary(m.inter)
anova(m.full, m.inter, test = "Chisq")
anova(m.inter)
```

# Automatic Variable Selection process


# Model comparison


# Model validation


# Model interpretation